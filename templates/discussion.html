<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Discussion - ClaimCheck</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: #f6f7f9;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      padding: 0;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }

    .header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-button {
      padding: 8px 16px;
      background: #f3f4f6;
      color: #374151;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .back-button:hover {
      background: #e5e7eb;
    }

    h1 {
      margin: 0;
      font-size: 24px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .view-json-btn {
      padding: 8px 16px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .view-json-btn:hover {
      background: #4338ca;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #f9fafb;
    }

    .chat-header {
      padding: 16px 24px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      color: #374151;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      color: white;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    .message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-agent {
      font-weight: 600;
      font-size: 14px;
      color: #111827;
    }

    .message-time {
      font-size: 12px;
      color: #6b7280;
    }

    .message-bubble {
      background: white;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      font-size: 14px;
      line-height: 1.5;
      color: #374151;
      word-wrap: break-word;
    }

    .message.system .message-bubble {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
    }

    .message.summary .message-bubble {
      background: #dbeafe;
      border-left: 3px solid #3b82f6;
    }

    .agent-CVClaimsAgent .message-avatar { background: #8b5cf6; }
    .agent-RepoVerificationAgent .message-avatar { background: #10b981; }
    .agent-LinkedInVerificationAgent .message-avatar { background: #0ea5e9; }
    .agent-LinkedInScraper .message-avatar { background: #06b6d4; }
    .agent-ReliabilityScoringAgent .message-avatar { background: #f59e0b; }
    .agent-SummaryAgent .message-avatar { background: #3b82f6; }
    .agent-SummaryWriter .message-avatar { background: #3b82f6; }
    .message.system .message-avatar { background: #6b7280; }

    .summary-card {
      margin-top: 12px;
      padding: 16px;
      background: #ecfeff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      font-size: 13px;
    }

    .summary-card strong {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .summary-card ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .summary-card li {
      margin: 4px 0;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .status-indicator.complete {
      background: #10b981;
      animation: none;
      opacity: 1;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .json-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .json-modal.active {
      display: flex;
    }

    .json-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 25px rgba(0,0,0,0.15);
    }

    .json-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .json-modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .json-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .json-modal-close:hover {
      background: #f3f4f6;
    }

    .json-modal-body {
      padding: 24px;
      overflow: auto;
      flex: 1;
    }

    .json-content {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="header">
      <div class="header-left">
        <a href="/" class="back-button">‚Üê Back</a>
        <h1>Agent Discussion</h1>
      </div>
      <div class="header-actions">
        <button class="view-json-btn" id="view-json-btn" style="display: none;">View Raw JSON</button>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <span id="status-text">Agent Discussion</span>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="message system">
          <div class="message-avatar">ü§ñ</div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-agent">System</span>
            </div>
            <div class="message-bubble">
              Starting analysis...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON Modal -->
  <div class="json-modal" id="json-modal">
    <div class="json-modal-content">
      <div class="json-modal-header">
        <h2>Raw JSON Data</h2>
        <button class="json-modal-close" id="json-modal-close">&times;</button>
      </div>
      <div class="json-modal-body">
        <pre class="json-content" id="json-content"></pre>
      </div>
    </div>
  </div>

  <script>
    const statusText = document.getElementById("status-text");
    const chatMessages = document.getElementById("chat-messages");
    const viewJsonBtn = document.getElementById("view-json-btn");
    const jsonModal = document.getElementById("json-modal");
    const jsonModalClose = document.getElementById("json-modal-close");
    const jsonContent = document.getElementById("json-content");
    let resultData = null;

    // Get session ID from URL or generate one
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session') || 'current';

    function getAgentInitials(agentName) {
      if (!agentName) return "?";
      const parts = agentName.replace(/Agent$/, "").split(/(?=[A-Z])/);
      if (parts.length >= 2) {
        return parts[0][0] + parts[1][0];
      }
      return agentName.substring(0, 2).toUpperCase();
    }

    function getAgentDisplayName(agentName) {
      if (!agentName) return "Unknown";
      return agentName.replace(/Agent$/, "").replace(/([A-Z])/g, " $1").trim();
    }

    function addMessage(agent, message, isSystem = false, isSummary = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isSystem ? "system" : ""} ${isSummary ? "summary" : ""} ${agent ? `agent-${agent}` : ""}`;
      
      const avatar = document.createElement("div");
      avatar.className = "message-avatar";
      if (isSystem) {
        avatar.textContent = "ü§ñ";
      } else if (agent) {
        avatar.textContent = getAgentInitials(agent);
      } else {
        avatar.textContent = "?";
      }

      const content = document.createElement("div");
      content.className = "message-content";

      const header = document.createElement("div");
      header.className = "message-header";

      const agentName = document.createElement("span");
      agentName.className = "message-agent";
      agentName.textContent = isSystem ? "System" : (agent ? getAgentDisplayName(agent) : "Unknown");

      const time = document.createElement("span");
      time.className = "message-time";
      time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      header.appendChild(agentName);
      header.appendChild(time);

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.textContent = message;

      content.appendChild(header);
      content.appendChild(bubble);

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingIndicator(agent) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message agent-${agent}`;
      messageDiv.id = "typing-indicator";
      
      const avatar = document.createElement("div");
      avatar.className = "message-avatar";
      avatar.textContent = getAgentInitials(agent);

      const content = document.createElement("div");
      content.className = "message-content";

      const bubble = document.createElement("div");
      bubble.className = "message-bubble typing-indicator";
      bubble.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

      content.appendChild(bubble);
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById("typing-indicator");
      if (indicator) {
        indicator.remove();
      }
    }

    function stopLoading() {
      const indicator = statusText.querySelector('.status-indicator');
      if (indicator) {
        indicator.classList.add('complete');
      }
    }

    // Load discussion from sessionStorage or start new stream
    const savedData = sessionStorage.getItem(`discussion_${sessionId}`);
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        resultData = data.result;
        
        // Restore messages
        if (data.messages && data.messages.length > 0) {
          chatMessages.innerHTML = '';
          data.messages.forEach(msg => {
            if (msg.type === 'message') {
              addMessage(msg.agent, msg.message, msg.isSystem, msg.isSummary);
            } else if (msg.type === 'summary') {
              const summaryDiv = document.createElement("div");
              summaryDiv.className = "message summary agent-SummaryAgent";
              const summaryAvatar = document.createElement("div");
              summaryAvatar.className = "message-avatar";
              summaryAvatar.textContent = getAgentInitials("SummaryAgent");
              const summaryContent = document.createElement("div");
              summaryContent.className = "message-content";
              const summaryHeader = document.createElement("div");
              summaryHeader.className = "message-header";
              const summaryAgentName = document.createElement("span");
              summaryAgentName.className = "message-agent";
              summaryAgentName.textContent = getAgentDisplayName("SummaryAgent");
              const summaryTime = document.createElement("span");
              summaryTime.className = "message-time";
              summaryTime.textContent = msg.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              summaryHeader.appendChild(summaryAgentName);
              summaryHeader.appendChild(summaryTime);
              const summaryBubble = document.createElement("div");
              summaryBubble.className = "message-bubble";
              summaryBubble.innerHTML = msg.html;
              summaryContent.appendChild(summaryHeader);
              summaryContent.appendChild(summaryBubble);
              summaryDiv.appendChild(summaryAvatar);
              summaryDiv.appendChild(summaryContent);
              chatMessages.appendChild(summaryDiv);
            }
          });
        }
        
        if (resultData) {
          viewJsonBtn.style.display = 'block';
          statusText.innerHTML = '<span class="status-indicator complete"></span>Discussion Complete';
          stopLoading();
        }
      } catch (e) {
        console.error('Error loading saved discussion:', e);
      }
    } else {
      // Start new stream using session ID
      startStream();
    }

    function startStream() {
      statusText.innerHTML = '<span class="status-indicator"></span>Agents are discussing...';
      
      const formData = new FormData();
      formData.append("session_id", sessionId);

      const messages = [];
      
      fetch("/stream", {
        method: "POST",
        body: formData,
      })
      .then(res => {
        if (!res.ok || !res.body) {
          statusText.textContent = "Error";
          addMessage(null, "Something went wrong. Please try again.", true);
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        let lastAgent = null;

        const processChunk = (chunk) => {
          buffer += chunk;
          const parts = buffer.split("\n\n");
          buffer = parts.pop() || "";
          for (const part of parts) {
            const lines = part.trim().split("\n");
            let event = "message";
            let dataLine = "";
            for (const line of lines) {
              if (line.startsWith("event:")) {
                event = line.slice(6).trim();
              } else if (line.startsWith("data:")) {
                dataLine += line.slice(5).trim();
              }
            }
            if (!dataLine) continue;
            let payload = {};
            try { payload = JSON.parse(dataLine); } catch (err) { payload = { raw: dataLine }; }

            removeTypingIndicator();

            switch (event) {
              case "status":
                statusText.innerHTML = '<span class="status-indicator"></span>' + (payload.message || "Processing...");
                addMessage(null, payload.message || "Starting analysis...", true);
                messages.push({ type: 'message', agent: null, message: payload.message || "Starting analysis...", isSystem: true });
                break;
              case "claims":
                addMessage("CVClaimsAgent", `I've extracted ${payload.count} verifiable claims from the CV. ${payload.summary || "Ready for verification."}`);
                messages.push({ type: 'message', agent: "CVClaimsAgent", message: `I've extracted ${payload.count} verifiable claims from the CV. ${payload.summary || "Ready for verification."}` });
                lastAgent = "CVClaimsAgent";
                break;
              case "repos":
                addMessage("RepoVerificationAgent", `I've fetched ${payload.count} GitHub repositories. Let me cross-check the claims against these repos.`);
                messages.push({ type: 'message', agent: "RepoVerificationAgent", message: `I've fetched ${payload.count} GitHub repositories. Let me cross-check the claims against these repos.` });
                lastAgent = "RepoVerificationAgent";
                break;
              case "verification":
                addMessage("RepoVerificationAgent", "I've completed the GitHub verification. Cross-referencing the claims with repository data now.");
                messages.push({ type: 'message', agent: "RepoVerificationAgent", message: "I've completed the GitHub verification. Cross-referencing the claims with repository data now." });
                lastAgent = "RepoVerificationAgent";
                break;
              case "linkedin_profile":
                const status = payload.status || "unknown";
                const linkedinMsg = status === "success" 
                  ? `Successfully fetched LinkedIn profile for ${payload.username || "the candidate"}.`
                  : `LinkedIn profile fetch ${status} for ${payload.username || "the candidate"}.`;
                addMessage("LinkedInScraper", linkedinMsg);
                messages.push({ type: 'message', agent: "LinkedInScraper", message: linkedinMsg });
                lastAgent = "LinkedInScraper";
                break;
              case "linkedin_verification":
                addMessage("LinkedInVerificationAgent", "I've completed the LinkedIn verification. Comparing profile data with CV claims.");
                messages.push({ type: 'message', agent: "LinkedInVerificationAgent", message: "I've completed the LinkedIn verification. Comparing profile data with CV claims." });
                lastAgent = "LinkedInVerificationAgent";
                break;
              case "reliability":
                addMessage("ReliabilityScoringAgent", `Based on the verification results, I've calculated a reliability score of ${payload.score ?? "N/A"}/100. ${payload.rationale || ""}`);
                messages.push({ type: 'message', agent: "ReliabilityScoringAgent", message: `Based on the verification results, I've calculated a reliability score of ${payload.score ?? "N/A"}/100. ${payload.rationale || ""}` });
                lastAgent = "ReliabilityScoringAgent";
                break;
              case "summary":
                const summaryHtml = `
                  <div class="summary-card">
                    <strong>Final Report (Score: ${payload.score ?? "N/A"}/100)</strong>
                    <div style="margin-top: 8px;">${payload.summary || ""}</div>
                    ${payload.highlights && payload.highlights.length > 0 ? `
                      <ul>
                        ${payload.highlights.map(h => `<li>${h}</li>`).join("")}
                      </ul>
                    ` : ""}
                  </div>
                `;
                const summaryDiv = document.createElement("div");
                summaryDiv.className = "message summary agent-SummaryAgent";
                const summaryAvatar = document.createElement("div");
                summaryAvatar.className = "message-avatar";
                summaryAvatar.textContent = getAgentInitials("SummaryAgent");
                const summaryContent = document.createElement("div");
                summaryContent.className = "message-content";
                const summaryHeader = document.createElement("div");
                summaryHeader.className = "message-header";
                const summaryAgentName = document.createElement("span");
                summaryAgentName.className = "message-agent";
                summaryAgentName.textContent = getAgentDisplayName("SummaryAgent");
                const summaryTime = document.createElement("span");
                summaryTime.className = "message-time";
                summaryTime.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                summaryHeader.appendChild(summaryAgentName);
                summaryHeader.appendChild(summaryTime);
                const summaryBubble = document.createElement("div");
                summaryBubble.className = "message-bubble";
                summaryBubble.innerHTML = summaryHtml;
                summaryContent.appendChild(summaryHeader);
                summaryContent.appendChild(summaryBubble);
                summaryDiv.appendChild(summaryAvatar);
                summaryDiv.appendChild(summaryContent);
                chatMessages.appendChild(summaryDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                messages.push({ type: 'summary', html: summaryHtml, time: summaryTime.textContent });
                lastAgent = "SummaryAgent";
                break;
              case "transcript":
                (payload || []).forEach((entry) => {
                  if (entry.agent && entry.message) {
                    addMessage(entry.agent, entry.message);
                    messages.push({ type: 'message', agent: entry.agent, message: entry.message });
                    lastAgent = entry.agent;
                  }
                });
                break;
              case "done":
                resultData = payload;
                viewJsonBtn.style.display = 'block';
                statusText.innerHTML = '<span class="status-indicator complete"></span>Discussion Complete';
                stopLoading();
                addMessage(null, "All agents have completed their analysis. Review the summary above.", true);
                messages.push({ type: 'message', agent: null, message: "All agents have completed their analysis. Review the summary above.", isSystem: true });
                
                // Save to sessionStorage
                sessionStorage.setItem(`discussion_${sessionId}`, JSON.stringify({
                  messages: messages,
                  result: resultData
                }));
                break;
              case "error":
                statusText.textContent = "Error";
                stopLoading();
                addMessage(null, `Error: ${payload.error || "An error occurred"}`, true);
                messages.push({ type: 'message', agent: null, message: `Error: ${payload.error || "An error occurred"}`, isSystem: true });
                break;
              default:
                addMessage(null, `${event}: ${JSON.stringify(payload)}`, true);
                messages.push({ type: 'message', agent: null, message: `${event}: ${JSON.stringify(payload)}`, isSystem: true });
            }

            // Add typing indicator for next agent
            if (lastAgent && event !== "done" && event !== "error") {
              setTimeout(() => {
                if (chatMessages.querySelector("#typing-indicator")) return;
                addTypingIndicator(lastAgent);
              }, 300);
            }
          }
        };

        const readStream = async () => {
          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              if (buffer.trim()) {
                processChunk("");
              }
              removeTypingIndicator();
              break;
            }
            const chunk = decoder.decode(value, { stream: true });
            processChunk(chunk);
          }
        };

        readStream().catch(err => {
          statusText.textContent = "Error";
          stopLoading();
          addMessage(null, err.message || "Request failed.", true);
          removeTypingIndicator();
        });
      })
      .catch(err => {
        statusText.textContent = "Error";
        stopLoading();
        addMessage(null, err.message || "Request failed.", true);
        removeTypingIndicator();
      });
    }

    // JSON Modal handlers
    viewJsonBtn.addEventListener('click', () => {
      if (resultData) {
        jsonContent.textContent = JSON.stringify(resultData, null, 2);
        jsonModal.classList.add('active');
      }
    });

    jsonModalClose.addEventListener('click', () => {
      jsonModal.classList.remove('active');
    });

    jsonModal.addEventListener('click', (e) => {
      if (e.target === jsonModal) {
        jsonModal.classList.remove('active');
      }
    });
  </script>
</body>
</html>

